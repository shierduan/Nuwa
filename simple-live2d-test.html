<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D 简化测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #canvas-container {
            width: 800px;
            height: 600px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        #status {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            width: 800px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        #log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            width: 800px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }
        
        .log-entry {
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .error {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .success {
            color: #4ecdc4;
        }
        
        button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <h1>Live2D 简化测试页面</h1>
    <div id="canvas-container">
        <canvas id="live2d-canvas"></canvas>
    </div>
    
    <div id="status">
        <h3>状态信息</h3>
        <div>PixiJS 加载: <span id="pixi-status">等待中...</span></div>
        <div>Live2D 库加载: <span id="live2d-lib-status">等待中...</span></div>
        <div>模型加载: <span id="model-status">等待中...</span></div>
        <div>渲染状态: <span id="render-status">等待中...</span></div>
        <div>鼠标追踪: <span id="mouse-status">未启用...</span></div>
    </div>
    
    <div style="margin-bottom: 20px;">
        <button onclick="loadModel()">重新加载模型</button>
        <button onclick="toggleMouseTracking()">切换鼠标追踪</button>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <div id="log">
        <div class="log-entry">[${getCurrentTime()}] 测试页面加载完成</div>
    </div>

    <!-- 使用兼容版本的 PIXI.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>
    
    <!-- 使用兼容版本的 pixi-live2d-display -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.2/dist/pixi-live2d-display.min.js"></script>
    
    <!-- 使用兼容版本的 Live2DCubismCore -->
    <script src="https://cdn.jsdelivr.net/npm/live2dcubismcore@4.2.0/live2dcubismcore.min.js"></script>

    <script>
        // 全局变量
        let app;
        let model;
        let mouseTrackingEnabled = false;
        
        // 初始化
        function init() {
            log('初始化 Pixi 应用...');
            updateStatus('pixi-status', '加载中...', '');
            
            try {
                // 创建 PIXI 应用
                app = new PIXI.Application({
                    view: document.getElementById('live2d-canvas'),
                    width: 800,
                    height: 600,
                    backgroundColor: 0x000000,
                    transparent: true
                });
                
                updateStatus('pixi-status', '成功', 'success');
                log('Pixi 应用初始化成功', 'success');
                
                // 检查 Live2D 库
                checkLive2DLib();
                
                // 加载模型
                loadModel();
                
                // 添加鼠标事件
                document.getElementById('canvas-container').addEventListener('mousemove', onMouseMove);
                document.getElementById('canvas-container').addEventListener('click', onMouseClick);
                
            } catch (error) {
                log('Pixi 应用初始化失败: ' + error.message, 'error');
                updateStatus('pixi-status', '失败', 'error');
            }
        }
        
        // 检查 Live2D 库
        function checkLive2DLib() {
            log('检查 Live2D 库...');
            updateStatus('live2d-lib-status', '检查中...', '');
            
            try {
                if (window.Live2DCubismCore && window.PIXI.live2d) {
                    updateStatus('live2d-lib-status', '成功', 'success');
                    log('Live2D 库加载成功', 'success');
                } else {
                    throw new Error('Live2D 库未正确加载');
                }
            } catch (error) {
                log('Live2D 库检查失败: ' + error.message, 'error');
                updateStatus('live2d-lib-status', '失败', 'error');
            }
        }
        
        // 加载模型
        function loadModel() {
            log('开始加载 Live2D 模型...');
            updateStatus('model-status', '加载中...', '');
            updateStatus('render-status', '等待渲染...', '');
            
            // 移除旧模型
            if (model) {
                app.stage.removeChild(model);
                model = null;
            }
            
            // 模型路径 - 使用CDN链接
            const modelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
            
            try {
                // 使用 PIXI.live2d.Live2DModel.from() 加载模型
                PIXI.live2d.Live2DModel.from(modelUrl)
                    .then(loadedModel => {
                        model = loadedModel;
                        
                        // 设置模型属性
                        model.scale.set(0.2);
                        model.interactive = true;
                        model.buttonMode = true;
                        
                        // 居中模型
                        model.position.set(app.screen.width / 2, app.screen.height);
                        model.anchor.set(0.5, 1);
                        
                        // 添加到舞台
                        app.stage.addChild(model);
                        
                        updateStatus('model-status', '成功', 'success');
                        updateStatus('render-status', '渲染中...', 'success');
                        log('模型加载成功并添加到舞台', 'success');
                        
                        // 添加交互事件
                        model.on('pointertap', () => {
                            if (model.motionManager) {
                                model.motionManager.startRandomMotion('Tap', 0);
                                log('播放 Tap 动画', 'success');
                            }
                        });
                        
                        // 播放默认动画
                        if (model.motionManager) {
                            model.motionManager.startRandomMotion('Idle', 0);
                            log('开始播放 Idle 动画', 'success');
                        }
                    })
                    .catch(error => {
                        log('模型加载错误: ' + error.message, 'error');
                        updateStatus('model-status', '失败', 'error');
                        
                        // 输出详细错误信息
                        if (error.stack) {
                            log('错误堆栈: ' + error.stack, 'error');
                        }
                    });
                
            } catch (error) {
                log('模型加载异常: ' + error.message, 'error');
                updateStatus('model-status', '失败', 'error');
            }
        }
        

        
        // 鼠标移动事件
        function onMouseMove(event) {
            if (!mouseTrackingEnabled || !model) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // 转换坐标到模型空间
            const modelX = (x / rect.width - 0.5) * 2;
            const modelY = (y / rect.height - 0.5) * 2;
            
            // 设置模型表情
            if (model.eyeBlink && model.lookAt) {
                model.lookAt(modelX, modelY);
            }
        }
        
        // 鼠标点击事件
        function onMouseClick(event) {
            if (!model || !model.motionManager) return;
            
            // 播放点击动画
            model.motionManager.startRandomMotion('Tap', 0);
            log('播放 Tap 动画', 'success');
        }
        
        // 切换鼠标追踪
        function toggleMouseTracking() {
            mouseTrackingEnabled = !mouseTrackingEnabled;
            updateStatus('mouse-status', mouseTrackingEnabled ? '已启用' : '未启用', mouseTrackingEnabled ? 'success' : '');
            log(`鼠标追踪 ${mouseTrackingEnabled ? '已启用' : '已禁用'}`, mouseTrackingEnabled ? 'success' : '');
        }
        
        // 更新状态
        function updateStatus(elementId, text, className) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                element.className = className;
            }
        }
        
        // 日志记录
        function log(message, type = '') {
            const logContainer = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${getCurrentTime()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 清空日志
        function clearLog() {
            const logContainer = document.getElementById('log');
            logContainer.innerHTML = `<div class="log-entry">[${getCurrentTime()}] 日志已清空</div>`;
        }
        
        // 获取当前时间
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('zh-CN', { hour12: false });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            init();
        });
        
        // 窗口大小调整
        window.addEventListener('resize', () => {
            if (app) {
                const container = document.getElementById('canvas-container');
                app.renderer.resize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>