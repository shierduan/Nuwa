# 女娲（Nuwa）功能与算法清单

> **生成时间**：2025-12-04（自动更新）  
> **来源**：当前代码基最新版本（含记忆梦境系统、状态持久化、语义场论集成）

---

## 📋 目录

1. [核心功能模块](#核心功能模块)
2. [算法与机制](#算法与机制)
3. [数据结构](#数据结构)
4. [系统流程](#系统流程)
5. [性能与监控](#性能与监控)
6. [待优化/规划中功能](#待优化规划中功能)

---

## 核心功能模块

### ✅ 1. `nuwa_state.NuwaState` — 状态管理
- 11 维核心状态向量：`energy / system_entropy / joy / anger / sadness / fear / trust / anticipation / social_hunger / curiosity / rapport`
- 情绪相关：
  - `emotional_spectrum`：当前情绪谱
  - `baseline_mood`：出厂“性格基准线”，用于情绪惯性回归
- 驱动力与关系：
  - `drives`: `social_hunger / curiosity`
  - `rapport`: 与用户的亲密度
- 时间元数据：`last_interaction_timestamp / uptime`（无 `created_at` 字段）
- 事实账本：
  - `fact_book: Dict[str, str]`：绝对事实（如姓名、关系、稳定偏好）
  - `_core_keys`：始终优先返回的关键事实键（如 `user_name / relationship`）
  - 线程安全访问：内部 `_lock`，提供 `retrieve_relevant_facts(query_text)` 与 `update_fact(key, value, source)`（前台对话 `user_interaction` 可覆盖，梦境 `dream` 仅补洞不覆盖冲突）
- 工具方法：
  - `to_vector()`、`clamp_values()`、`to_dict() / from_dict()`
  - `save(path)` / `load(path)`：JSON 持久化，自动处理缺省文件
- 离线衰减：内核启动时根据停机时长调用 `BioRhythm.decay()` 进行一次性代谢演算

### ✅ 2. `drive_system.BioRhythm` — 生物节律调控
- `PIDController`：熵值与情绪使用 PID 回归控制（积分限幅 + 输出限幅）
- `decay()`：生物代谢模型（更拟真，而非简单线性衰减）
  - 精力恢复：休息时按照 `recovery_rate≈1e-4/s` 缓慢回满（数小时级）
  - 疲劳压制：计算 `energy_factor` 抑制社交饥渴与好奇心增长（能量低时“躺平”）
  - 社交饥渴：基于 `energy_factor` 的缓慢上升曲线（数十小时接近饱和）
  - 好奇心：指数衰减，能量低于 0.3 时衰减加速（累了就“不想好奇”）
- `regulate()`：熵值回归到 0，同时基于 `baseline_mood` 做“情绪惯性回归`
  - 为不同情绪设定不同回归速度（如 anger/sadness 慢、joy/fear 快、trust/anticipation 中等），模拟“记仇”“快乐易逝”等性格特征
- `update()`：统一节拍入口 = `decay(time_delta) + regulate()`

### ✅ 3. `memory_cortex.MemoryCortex` — 记忆皮层
- LanceDB + PyArrow Schema（字段：`id/text/vector/emotion_vector/timestamp/importance/type/emotions/access_count`）
- Embedding：SentenceTransformer（本地缓存 `~/.nuwa/models`，兼容旧 TAIYI 环境变量）
- 核心方法：
  - `store_memory()`：自动补全情绪/重要性/类型字段
  - `recall_by_emotion()`：语义 + 情绪加权检索，同时自增 `access_count`
  - `get_recent_memories()`、`delete_memories()`：提供梦境系统查询/删除管道
  - 记忆格式化：返回本地时间 + 相对时长，便于提示词构建

### ✅ 4. `memory_dreamer.MemoryDreamer` — 记忆压缩与遗忘（Memory Dreamer）
- 参数：`HALF_LIFE_DAYS=7`、`ALPHA_EMOTION=0.5`、`BETA_FREQ=0.2`
- `_calculate_score()`：采用半衰期 + 情绪强度 + 访问频次的综合评分
- `start_dreaming()`：
  - 预处理与坏向量清理：
    - 从 LanceDB 抽取最近 `MAX_MEMORIES` 条 `type="raw"` 记忆
    - 过滤 `None` / 空向量 / 零长度向量
    - 过滤包含 `NaN/Inf` 的异常向量
    - 过滤范数为 0 的纯零向量
    - 将上述“坏向量”记忆的 `id` 收集后，统一调用 `delete_memories` 物理删除，避免污染后续检索与聚类
  - 距离与聚类：
    - 对剩余向量做归一化
    - 使用 `pdist(..., metric="euclidean")` + `squareform` 构造欧氏距离矩阵
    - 若距离矩阵仍包含 `NaN/Inf`，放弃本轮整理以保证稳定性
    - 使用 DBSCAN（`metric="precomputed"`, `eps=0.3`, `min_samples=2`）在预计算欧氏距离上聚类
  - 簇内策略：
    - 噪声簇或 `avg_score < 0.2` → **遗忘**：批量删除这些记录的 `id`
    - `0.2 ≤ avg_score < 0.8` → **压缩**：
      - 将簇内原始文本拼接，交给 LLM，请求 JSON 输出：`{"summary": "...", "facts": {...}}`
      - 写入一条新的 `type="summary"` 记忆（`importance=1.0`），并聚合情绪为摘要的情绪标签
      - 删除簇内原始 `raw` 记忆
      - 调用 `_record_fact_updates(facts)` 将提取出的事实写入 `NuwaState.fact_book`，以 `source="dream"` 低优先级写入（仅补充，不覆盖与用户已确认事实冲突的值）
    - `avg_score ≥ 0.8` → **铭刻**：高价值记忆簇原样保留
- `/dream` 指令手动触发 Memory Dreamer；自动梦境调度由内核心跳在“时间间隔 + 低社交饥渴 + 能量充足”的条件下异步调用

### ✅ 5. `nuwa_kernel.NuwaKernel` — 核心内核
- 初始化：
  - 加载 `NuwaState`，根据 `last_interaction_timestamp` 计算离线时长，并用 `BioRhythm.decay(offline_time)` 做一次性离线代谢
  - 初始化 `BioRhythm / MemoryCortex / MemoryDreamer`
  - 初始化 LM Studio OpenAI 兼容客户端（`base_url`、`api_key`、`model_name`）
  - 初始化语义场论：从固定人格描述生成 `_core_vector`，维护 `_state_vector_history` 与 `_last_semantic_analysis`
- `heartbeat_loop()`：
  - 每秒 `tick`：
    - 调用 `drive_system.decay(time_delta)` 更新能量 / 驱动力 / 情绪 / uptime
    - 当 `social_hunger > 0.85` 且冷却时间已过时，调用 `initiate_active_dialogue()` 生成主动对话
  - 每 30 秒自动 `save_state()`
  - 调用 `_maybe_trigger_memory_dream(current_time)`：
    - 条件：距离上次做梦超过 `_dream_interval`（默认 15 分钟）
    - `social_hunger <= 0.6` 且 `energy >= 0.2`
    - 在后台线程中执行 `MemoryDreamer.start_dreaming()`，输出自动梦境日志
- `process_input(user_input: str, system_instruction: Optional[str] = None)`：
  1. 更新时间戳，并根据输入类型消耗能量：
     - 普通用户对话：`consume_energy(0.04)`（约 4% 精力）
     - 系统指令 `/sys`：`consume_energy(0.005)`（轻量消耗）
  2. 若是普通对话且 `energy <= 0.05`：
     - 直接进入「低功耗保护模式」，返回固定的“太累了，需要休息”的中文回复
     - 轻微增加 `system_entropy`，降低 `curiosity`，并 `clamp_values()`
     - 不再调用 LLM
  3. 从 `emotional_spectrum` 构造情绪向量，确定 `query_text = user_input or system_instruction or "当前状态"`
  4. 事实检索：
     - 调用 `NuwaState.retrieve_relevant_facts(query_text)`：
       - 始终返回 `_core_keys`（如 `user_name / user_role / relationship`）
       - 再按关键词匹配只挑与当前话题相关的事实，避免把整个 `fact_book` 塞进 Prompt
  5. 记忆检索与潜意识过滤：
     - 通过 `_enhance_memory_retrieval_with_semantic_field(...)` 按语义 + 情绪检索相关记忆
     - 额外检索一次“用户身份 名字 开发者 父亲”等身份类记忆，和前者合并去重
     - 使用 `_sanitize_memories()` 过滤掉包含“记忆功能还在学习中 / 我不记得了 / 很抱歉 / AI 模型 / 语言模型 …”等低价值自我道歉片段
     - 按相似度排序取前若干条，并用 `_format_memory_entry` 格式化为带时间线的 `[Memory Fragment]` 描述
  6. Prompt 构建：
     - `_build_system_prompt()` 定义：
       - `<thought>/<speak>/<state_update>/<fact_update>` 协议
       - `<memory_protocol>`：用户陈述的事实是最高真理，过去“我不记得了/很抱歉”类回答必须忽略
       - `<fact_update>` 只允许记录长期客观事实，不记录情绪、临时状态或推测
     - `_build_prompt(user_input, memories, system_instruction, relevant_facts)`：
       - `<context_layer>` 中包含：
         - `[Absolute Facts (Truth)]`：由 `relevant_facts`（及核心 fact）生成的事实块
         - 当前数值状态与 `[Self-Awareness]` 生理感受（`_get_physiological_description()`）
         - 语义场分析结果 `character_consistency / causal_coherence / energy_delta`
         - `[SYSTEM / DEVELOPER EVENT]`：当有 `system_instruction` 时标明为系统事件
  7. LLM 调用与解析：
     - `_call_llm(prompt)` 调用 LM Studio
     - `_parse_response(response_text)` 提取 `<thought>` / `<speak>` / `<state_update>`，对 JSON 容错
     - 额外使用正则抓取所有 `<fact_update>...</fact_update>`，经 `_parse_json_fragment` 解析后调用 `update_fact(..., source="user_interaction")` 写入 fact_book
  8. 状态更新与语义闭环：
     - `_apply_state_update(state_update)` 对情绪、驱动力、energy、system_entropy、rapport 做增量更新，再 `clamp_values()`
     - `_analyze_semantic_evolution(query_text, reply)`：
       - 将「谁说了什么」向量化，更新 `_state_vector_history`
       - 计算潜能变化，得到 `character_consistency / causal_coherence / energy_delta`
     - `_auto_adjust_curiosity_from_semantic()`：
       - 结合 `energy_delta` 与一致性指标，在极小范围内自动微调好奇心（新颖且一致 → 略升，重复 → 略降）
  9. 记忆写入：
     - 普通对话：写入 `用户: ...\n女娲: ...` 为 `type="raw"` 记忆，附带情绪、importance≈rapport、emotion_vector、access_count=0
     - 系统指令：不存指令文本；若有 `<thought>`，以 `女娲的顿悟: {thought}` 写入 `type="epiphany"` 记忆
- 其他：
  - `initiate_active_dialogue()`：在社交饥渴高企时构造上下文，让 LLM 输出简短主动问候；若 `<state_update>` JSON 解析失败，会回退为简单降低 `social_hunger`
  - `run_memory_dream()`：协程封装 Memory Dreamer，供 `/dream` 和自动梦境调度共用
  - `_get_time_context()`：以本地时区描述当前时间、上次互动时间与累计运行时长

### ✅ 6. `main.NuwaConsole` — 控制台应用
- Colorama 初始化：系统消息绿色、用户输入青色、女娲回复白色、生理监控洋红色
- 异步控制流：
  - `console_loop()`：
    - 基本命令：
      - `exit / quit`：退出程序（触发状态保存）
      - `/status`：打印一次当前状态快照
      - `/dream`：手动触发 Memory Dreamer
      - `/set [key] [value]`：调试命令，动态修改状态（如 `/set energy 1.0`、`/set joy 0.8`、`/set hunger 0.5`）：
        - 可修改 `NuwaState` 核心属性（energy/system_entropy 等）
        - 可修改情绪（joy/anger/sadness/fear/trust/anticipation）
        - 可修改驱动力（social_hunger/curiosity，`hunger` 为别名）
        - 每次修改后自动 `clamp_values()` 并打印监控快照
      - `/sys [instruction]`：以系统/开发者身份发送一次性指令：
        - 作为 `system_instruction` 传给 `NuwaKernel.process_input`
        - 不写入普通对话记忆，只在有 `<thought>` 时写入 `type="epiphany"` 顿悟记忆
    - 其它任意输入：按普通用户对话交给 `NuwaKernel.process_input`
    - 控制台显示：
      - 主动对话：`女娲 (主动) > ...`
      - 被动回复：`[回复] 女娲: ...`
      - 思维日志：`[思维] ...`（展示 `<thought>` 内容，方便调试）
  - `monitor_loop()`：
    - 每 10 秒打印一次生理监控，示例：
      - `[生理监控] 精力(Energy): ... | 熵值(Entropy): ... | 亲密度(Rapport): ... 驱动力 -> 社交饥渴: ... | 好奇心: ... 情绪谱 -> 快乐:... | 愤怒:... | ...`
- Graceful 退出：捕获 `KeyboardInterrupt`，在退出前调用 `save_state()` 并输出提示
- Active message：内核通过回调将 `initiate_active_dialogue()` 的输出推送到控制台，带有“主动”前缀

### ✅ 7. 语义场论 (`semantic_field.py`)
- 模型缓存去除 Streamlit 依赖，纯 Python 全局缓存
- 提供：`vectorize_state / StateVector / calculate_potential_energy / calculate_gradient / evolve / inverse_collapse`
- 内核用法：维护语义向量历史、在 Prompt 中注入 `character_consistency / causal_coherence / current_energy`

---

## 算法与机制

| 类别 | 实现内容 |
| --- | --- |
| **控制与代谢** | PID 调节；精力在休息时按缓慢速率恢复；能量越低，社交饥渴与好奇心增长越被压制；社交饥渴缓慢上升；好奇心指数衰减（能量低时加速）；基于 `baseline_mood` 的情绪惯性回归（不同情绪不同回归速度） |
| **记忆管理** | 语义 + 情绪加权检索；访问计数；时间语境化；做梦阶段按评分忘却/压缩/铭刻；梦境开始前主动清理包含 NaN/Inf/零向量的“坏记忆”，避免污染后续检索与聚类 |
| **语义场论** | 状态向量化；Narrative Hamiltonian 能量分析；语义演化与逆向坍缩用于增强记忆检索与状态轨迹；基于语义新颖度与人设/因果一致性的好奇心非线性微调 |
| **LLM 协议** | `<thought>` + `<speak>` + `<state_update>` + `<fact_update>`；严格区分思维与发言；`<state_update>` 为增量 JSON，具备解析容错；`<fact_update>` 仅用于长期客观事实写入 fact_book，不记录情绪、临时状态或猜测 |
| **时间感知** | Prompt 注入当前本地时间、最后互动时间、累计运行时长；记忆显示“多久之前”；启动时根据离线时长应用一次性代谢衰减 |
| **状态闭环** | LLM 输出 `<state_update>` 形成状态增量 → `_apply_state_update()` + 基于语义场的好奇心微调 → `clamp_values()` → Heartbeat 中的代谢/回归进一步演化，形成连续的生理与情绪闭环 |
| **主动行为** | 心跳中检测 `social_hunger` 高于阈值时触发 `initiate_active_dialogue()`，根据既有记忆主动发起简短对话，并在成功或失败时相应降低饥渴值，避免频繁触发 |
| **事实检索** | 使用 `NuwaState.fact_book` 与 `retrieve_relevant_facts`，仅当与当前话题相关时注入事实块；通过 `_core_keys` 保证姓名/关系等关键事实始终在线；前台对话具备覆盖权限，梦境整理仅补充不覆盖冲突 |
| **持久化** | `NuwaState.save/load` + 心跳定期保存 + 每轮交互后即时保存；`baseline_mood`、`fact_book` 等一并持久化；LanceDB 记忆与梦境整理结果（包括坏向量清理）长期存储 |

---

## 数据结构

### NuwaState 向量
```
[energy, system_entropy, joy, anger, sadness, fear, trust, anticipation, social_hunger, curiosity, rapport]
```

### Memory LanceDB Schema
```
{
  id: string,
  text: string,
  vector: list[float32 × 384],
  emotion_vector: string,   # JSON 序列化的情绪嵌入
  timestamp: float64,
  importance: float32,
  type: string,             # raw / summary / active / other
  emotions: string,         # JSON dict，用于 Memory Dreamer
  access_count: int64
}
```

### MemoryDreamer Score 相关字段
- `importance`：默认 0.5，摘要记忆写成 1.0  
- `emotions`：LLM/状态机提供的情绪字典  
- `access_count`：每次检索命中时自增，用于频率奖励

---

## 系统流程

### 1. 启动
```
加载状态 → 离线衰减 → 初始化 MemoryCortex/MemoryDreamer/LM Studio → 启动 heartbeat → 启动 console + monitor
```

### 2. 对话
```
用户输入（或 /sys 系统指令）
→ 更新时间戳 & 按类型消耗能量（普通对话约 4%，系统指令约 0.5%）
→ 若为普通对话且能量过低则直接进入保护模式，拒绝继续深聊
→ 从情绪谱构造情绪向量，调用 retrieve_relevant_facts 提取与本轮话题相关的事实
→ 通过语义+情绪检索记忆，并用潜意识过滤器剔除“记忆功能还在学习中/我不记得了/很抱歉/AI 模型/语言模型”等低价值记忆
→ 构建 Prompt：状态 + 生理自我感受 + 事实账本 + 记忆碎片 + 语义场分析 + 时间上下文 +（可选）系统指令
→ LM Studio 输出 thought/state_update/speak/fact_update
→ 解析并应用 <state_update> 增量，结合语义场分析自动微调好奇心
→ 解析 <fact_update> 并将长期客观事实写入 fact_book（前台具备覆盖权）
→ 存储互动记忆（普通对话 type=raw，系统指令仅存 type=epiphany 顿悟）
→ 记录语义向量历史，更新语义场分析结果
→ 在控制台分别输出 [思维] 与 [回复] 女娲:，用户只看到 <speak> 内容
```

### 3. 心跳
```
循环 1s：
→ drive_system.decay(time_delta)（精力恢复、驱动力与情绪自然演化）
→ drive_system.regulate()（PID 纠偏熵值 + 基于 baseline_mood 的情绪惯性回归）
→ 检查 social_hunger，高于阈值且冷却时间已过时调用 initiate_active_dialogue()，将主动发言通过回调输出到控制台
→ 每隔一段时间保存状态到磁盘
→ 满足“时间间隔 + 低社交饥渴 + 能量充足”条件时调用 _maybe_trigger_memory_dream()，在后台执行 Memory Dreamer
```

### 4. 做梦（Memory Dream）
```
/dream 指令或内核自动调度 → 后台线程从 LanceDB 抽取最近 raw 记忆
→ 首先清理包含 NaN/Inf/零范数的“坏向量”记忆并物理删除
→ 对剩余记忆向量做归一化并构造欧氏距离矩阵，使用 DBSCAN 聚类
→ 对每个簇根据综合评分决定：忘却噪声 / 压缩为 summary（并提取 JSON facts 写入 fact_book）/ 铭刻高价值记忆
→ 将压缩结果和删除动作回写 LanceDB
→ 在控制台输出梦境整理日志（包含清理条数、簇数、铭刻/压缩/遗忘概况）

```

---

## 性能与监控

- **监控输出**：固定 10 秒打印 `[生理监控] Energy | Hunger | Entropy`，便于观察调试
- **日志**：`thought` 持久化至 `nuwa.log`，可对比公开发言
- **错误韧性**：LLM 调用失败、JSON 解析异常、旧 LanceDB 表结构 → 均有回退与用户提示
- **资源**：向量缓存于本地，避免重复下载；Memory Dreamer 在 `asyncio.to_thread` 中运行，不阻塞交互

---

## 待优化/规划中功能

1. **语义场论闭环强化**  
   - ✅ 已完成：当前对话会被向量化进入语义场，使用 `calculate_potential_energy()` 评估人设一致性与因果连贯性，并调用 `evolve()` 迭代出“理想下一步语义向量”；演化结果一方面通过数值形式注入 Prompt（作为对 LLM 的软约束），另一方面作为逆向坍缩的目标向量，影响后续记忆检索与语义轨迹，使语义场论真正参与到闭环决策之中（数值演化 + 记忆选择 + LLM `<state_update>` 共同决定状态演化）。

2. **驱动力多样化更新**  
   - ✅ 已实现：`curiosity` 在每次对话后，会结合语义场演化结果自动微调——当语义新颖且人设/因果一致时，略微提升好奇心；当对话高度重复且语义变化很小，则轻微降低，好奇心最终由 LLM 的 `<state_update>` 与这一语义启发式共同决定，无需额外打分模型协同。

3. **自动化梦境调度**  
   - ✅ 已实现：心跳循环监测“15分钟间隔 + 低社交饥渴 + 能量充足”三个条件，满足时自动调用 Memory Dreamer 进行后台整理，并在控制台输出“自动梦境整理”提示；仍可用 `/dream` 手动触发。

4. **评估与测试体系**  
   - 缺少单元测试 / 集成测试，建议针对状态持久化、Memory Dreamer、LLM 解析编写测试集。

5. **多模态记忆与层级索引**  
   - 目前仅处理文本记忆，后续可扩展为多模态特征、层级索引（事件 → 摘要 → 时间线）。

6. **社交/亲密度建模深化**  
   - `rapport` 目前主要来自 `<state_update>` 增量，建议引入基于互动频率与情绪共振的独立模型，以提升一致性。

---

**文档结束（自动生成，随代码更新需重新审阅）**
